#define _XOPEN_SOURCE_EXTENDED

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <locale.h>
#include <signal.h>
#include <termios.h>
#include <ncursesw/ncurses.h>
#include <sys/socket.h>
#include <arpa/inet.h>
#include <stdbool.h>
#include <wchar.h>
#include <time.h>

#include "../global.h"
#include "../Diver_ui.h"
#include "json_topic.h"

#define BUF_SIZE    1024
#define LOG_LINES   5
#define MAX_DATA    200
#define FILLED_CHR  "‚ñà"
#define EMPTY_CHR   " "
#define BAR_LEN     20

static char logs[LOG_LINES][BUF_SIZE];
static int  logi = 0;
static char opponent_name[32] = "???";

// Î°úÍ∑∏ ÏåìÍ∏∞
void add_log(const char *msg) {
    strncpy(logs[logi % LOG_LINES], msg, BUF_SIZE - 1);
    logs[logi % LOG_LINES][BUF_SIZE - 1] = '\0';
    logi++;
}

// Î°úÍ∑∏ Í∑∏Î¶¨Í∏∞
void draw_logs() {
    int start = logi > LOG_LINES ? logi - LOG_LINES : 0;
    for (int i = 0; i < LOG_LINES; i++)
        mvprintw(28 + i, 4, "%s", logs[(start + i) % LOG_LINES]);
}


// Ï≤¥Î†• Î∞î
void draw_bar(int y, int x, int val, int max_val, const char *lab){
    int v = val<0?0:(val>max_val?max_val:val);
    int f = v*BAR_LEN/max_val;
    mvprintw(y, x, "%-8s ", lab);
    for(int i=0;i<BAR_LEN;i++) printw(i<f?FILLED_CHR:EMPTY_CHR);
    printw(" %3d/%3d", v, max_val);
}

// Ïª®Ìä∏Î°§ ÏÑ§Ï†ï
void draw_ctrl() {
    mvprintw(28, 90, "[Ctrl+X] ATTACK   [Ctrl+Z] BLOCK");
    mvprintw(30, 90, "[Ctrl+C] Charge√ó3 [Ctrl+A] Charge√ó5");
    mvprintw(32, 90, "[Ctrl+S] COUNTER");
}

// ÎèÑÌä∏ÏïÑÌä∏ Í∑∏Î¶¨Í∏∞ Î≥∏Ïù∏
void draw_dot_art() {
    const char *art[] = {
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚£§‚£†‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£û‚°∑‚£ª‚¢û‚°≥‚£è‚¢æ‚°π‚£ñ‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢æ‚£±‚¢è‚°∑‚¢´‚†µ‚£©‚†é‚°µ‚†à‚†ú‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚£ú‚¢Ø‚°ú‚££‚¢£‚°ë‚¢é‚†ê‚£Å‚†¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Æ‚¢≥‚°π‚¢∞‚°ê‚†Ñ‚†¢‚¢Ñ‚¢®‚†Å‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£á‚¢É‚†í‚°†‚†ô‚£Ç‚†°‚¢å‚¢Ç‚°ë‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°∏‚¢Ä‚†£‚¢à‚†∞‚°Ä‚¢º‚†≥‚£å‚†¢‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚¢¢‚†ë‚†Ç‚°å‚†Ñ‚†Ç‚†ë‚†é‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚°†‚†å‚°Ä‚†ê‚°Ä‚¢å‚°ë‚††‚¢à‚†ê‚††‚†à‚°ê‚††‚††‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢†‚¢£‚°ë‚¢Ü‚†ê‚°Ä‚†ê‚°Ü‚¢Ñ‚†£‚†ê‚†®‚†ê‚††‚†Ä‚†ê‚†Ä‚†Ç‚†à‚¢Ñ‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚†í‚°ú‚£å‚††‚£Ä‚†π‚°ê‚¢å‚†Ü‚†°‚¢à‚†Å‚¢Ü‚†Å‚†å‚†ê‚†Ä‚†°‚¢à‚†Ñ‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚¢ã‚†¥‚°®‚†î‚£Ä‚†≥‚°à‚¢û‚†§‚¢Å‚†Ç‚†å‚°Ä‚¢ä‚†î‚°°‚¢à‚†ê‚¢†‚†ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢ß‚£ã‚¢ñ‚°°‚¢´‚†Ñ‚££‚†ë‚¢é‚°ñ‚°à‚¢å‚††‚°ë‚°å‚£û‚†°‚¢Ç‚†ú‚°†‚†É‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚£Æ‚°ë‚°£‚¢é‚°±‚£â‚†Ü‚°ô‚¢¶‚£à‚†±‚°ê‚°°‚¢è‚°î‚†Ä‚¢Ç‚†°‚°Å‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚¢¶‚°ô‚¢∂‚¢°‚¢ö‚°•‚¢ä‚°±‚†å‚¢¶‚†±‚£†‚†£‚£è‚†î‚°â‚¢Ä‚†¢‚£Å‚†Ä‚†Ä‚†Ä",
        "‚†à‚¢¶‚°ô‚¢Æ‚°ù‚¢Æ‚°ë‚°é‚°µ‚£É‚†ñ‚°©‚¢Ü‚°±‚¢†‚¢õ‚°º‚£ä‚†î‚°Å‚¢¢‚†ê‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†ß‚£ú‚¢£‚†û‚£•‚¢õ‚°¨‚°±‚£è‚¢é‚°±‚¢å‚†≤‚£°‚¢è‚°æ‚£±‚¢ä‚†î‚°†‚¢ç‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†≥‚£å‚¢ß‚¢´‚†Ä‚£è‚†∂‚°ë‚£é‚¢Æ‚¢±‚£ä‚†ï‚°¢‚¢è‚°æ‚°±‚¢´‚†Ñ‚°±‚¢å‚¢Ç‚†Ä‚†Ä",
        "‚†Ä‚†ò‚°¨‚¢é‚°≠‚¢≥‚°å‚¢≥‚°ë‚£é‚¢Ü‚†£‚¢å‚¢ä‚†±‚£©‚¢û‚°•‚£õ‚†º‚£†‚¢â‚†≤‚°Ä‚†Ä"
    };
    for (int i = 0; i < sizeof(art)/sizeof(art[0]); i++) {
        mvprintw(7 + i, 15, "%s", art[i]);
    }
}

// ÎèÑÌä∏ÏïÑÌä∏ Í∑∏Î¶¨Í∏∞ ÏÉÅÎåÄ
void draw_dot_art_enemy() {
    const char *art[] = {
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚£§‚£†‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£û‚°∑‚£ª‚¢û‚°≥‚£è‚¢æ‚°π‚£ñ‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢æ‚£±‚¢è‚°∑‚¢´‚†µ‚£©‚†é‚°µ‚†à‚†ú‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚£ú‚¢Ø‚°ú‚££‚¢£‚°ë‚¢é‚†ê‚£Å‚†¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Æ‚¢≥‚°π‚¢∞‚°ê‚†Ñ‚†¢‚¢Ñ‚¢®‚†Å‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£á‚¢É‚†í‚°†‚†ô‚£Ç‚†°‚¢å‚¢Ç‚°ë‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°∏‚¢Ä‚†£‚¢à‚†∞‚°Ä‚¢º‚†≥‚£å‚†¢‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚¢¢‚†ë‚†Ç‚°å‚†Ñ‚†Ç‚†ë‚†é‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä  ‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚°†‚†å‚°Ä‚†ê‚°Ä‚¢å‚°ë‚††‚¢à‚†ê‚††‚†à‚°ê‚††‚††‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢†‚¢£‚°ë‚¢Ü‚†ê‚°Ä‚†ê‚°Ü‚¢Ñ‚†£‚†ê‚†®‚†ê‚††‚†Ä‚†ê‚†Ä‚†Ç‚†à‚¢Ñ‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚†í‚°ú‚£å‚††‚£Ä‚†π‚°ê‚¢å‚†Ü‚†°‚¢à‚†Å‚¢Ü‚†Å‚†å‚†ê‚†Ä‚†°‚¢à‚†Ñ‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚¢ã‚†¥‚°®‚†î‚£Ä‚†≥‚°à‚¢û‚†§‚¢Å‚†Ç‚†å‚°Ä‚¢ä‚†î‚°°‚¢à‚†ê‚¢†‚†ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢ß‚£ã‚¢ñ‚°°‚¢´‚†Ñ‚££‚†ë‚¢é‚°ñ‚°à‚¢å‚††‚°ë‚°å‚£û‚†°‚¢Ç‚†ú‚°†‚†É‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚£Æ‚°ë‚°£‚¢é‚°±‚£â‚†Ü‚°ô‚¢¶‚£à‚†±‚°ê‚°°‚¢è‚°î‚†Ä‚¢Ç‚†°‚°Å‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚¢¶‚°ô‚¢∂‚¢°‚¢ö‚°•‚¢ä‚°±‚†å‚¢¶‚†±‚£†‚†£‚£è‚†î‚°â‚¢Ä‚†¢‚£Å‚†Ä‚†Ä‚†Ä",
        "‚†à‚¢¶‚°ô‚¢Æ‚°ù‚¢Æ‚°ë‚°é‚°µ‚£É‚†ñ‚°©‚¢Ü‚°±‚¢†‚¢õ‚°º‚£ä‚†î‚°Å‚¢¢‚†ê‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†ß‚£ú‚¢£‚†û‚£•‚¢õ‚°¨‚°±‚£è‚¢é‚°±‚¢å‚†≤‚£°‚¢è‚°æ‚£±‚¢ä‚†î‚°†‚¢ç‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†≥‚£å‚¢ß‚¢´‚†Ä‚£è‚†∂‚°ë‚£é‚¢Æ‚¢±‚£ä‚†ï‚°¢‚¢è‚°æ‚°±‚¢´‚†Ñ‚°±‚¢å‚¢Ç‚†Ä‚†Ä",
        "‚†Ä‚†ò‚°¨‚¢é‚°≠‚¢≥‚°å‚¢≥‚°ë‚£é‚¢Ü‚†£‚¢å‚¢ä‚†±‚£©‚¢û‚°•‚£õ‚†º‚£†‚¢â‚†≤‚°Ä‚†Ä"
    };
    int lines = sizeof(art)/sizeof(art[0]);
    setlocale(LC_ALL, "");
    for (int i = 0; i < lines; i++) {
        wchar_t wbuf[128];
        mbstowcs(wbuf, art[i], 128);
        int len = wcslen(wbuf);
        for (int j = 0; j < len/2; j++) {
            wchar_t tmp = wbuf[j];
            wbuf[j] = wbuf[len-1-j];
            wbuf[len-1-j] = tmp;
        }
        char mbbuf[256];
        wcstombs(mbbuf, wbuf, 256);
        mvprintw(7 + i, 91, "%s", mbbuf);
    }
}

// Ïä§ÌÖåÏù¥ÌÑ∞Ïä§ ÌëúÍ∏∞
void draw_status(
    const char* nick,
    int my_data, int my_max_data, int my_charge,
    const char* opponent_name,
    int en_data, int en_max_data, int en_charge
) {
    mvprintw(1, 2,  "üßë You:   %-12s", nick);
    draw_bar(3, 2, my_data, my_max_data, "DATA");
    draw_bar(5, 2, my_charge, 500, "‚ö°CHARGE");
    mvprintw(1, 90, "üëæEnemy:  %-12s", opponent_name);
    draw_bar(3, 90, en_data, en_max_data, "DATA");
    draw_bar(5, 90, en_charge, 500, "‚ö°CHARGE");
    draw_dot_art();
    draw_dot_art_enemy();
}

// PVPÍ≤åÏûÑ Î©îÏù∏Î£®ÌîÑ
int run_pvp_mode(int sock) {
    def_shell_mode();
    setlocale(LC_ALL,"");

    char buf[BUF_SIZE];
    //ÏÑúÎ≤ÑÏóê Î†àÏßÄÏä§ÌÑ∞ json Ï†ÑÏÜ°
    long long ts = get_current_time_ms();
    snprintf(buf, BUF_SIZE,
        "{\"action\":\"REGISTER\",\"nickname\":\"%s\","
        "\"data\":%d,\"max_data\":%d,\"atk\":%d,\"dfs\":%d,"
        "\"pvp_charge_minus\":%d,"
        "\"pvp_counter_atk_power_stat\":%.2f,"
        "\"pvp_charge_strong\":%.2f,"
        "\"timestamp\":%lld}",
        Player.nick, Player.data, Player.max_data, Player.atk_stat, Player.dfs_stat,
        Player.pvp_charge_minus,
        Player.pvp_counter_atk_power_stat,
        Player.pvp_charge_strong,
        ts
    );
    send(sock, buf, strlen(buf), 0);


    initscr(); def_prog_mode();
    raw(); noecho(); keypad(stdscr, TRUE);
    nodelay(stdscr, TRUE); timeout(0); curs_set(0);
    start_color();
    init_pair(1, COLOR_RED,    COLOR_BLACK);
    init_pair(2, COLOR_GREEN,  COLOR_BLACK);
    init_pair(5, COLOR_YELLOW, COLOR_BLUE);
    init_pair(6, COLOR_WHITE,  COLOR_MAGENTA);
    init_pair(7, COLOR_WHITE,  COLOR_RED);

    int my_data = Player.data, my_max_data = Player.max_data, my_charge = 0;
    int en_data = Player.data, en_max_data = Player.max_data, en_charge = 0;

    long long delay_until = 0;
    int in_delay = 0;

    int result = 0;

    int animation_index = 0;
    char recv_buf[1024] = {0};
    while (1) {
        // 1. Î°úÎî© Ïï†ÎãàÎ©îÏù¥ÏÖò Ìïú ÌîÑÎ†àÏûÑ Ï∂úÎ†•
        loading_screen_frame(animation_index);
        animation_index = (animation_index+1)%3;
        usleep(500000); // 0.5Ï¥à

        // 2. ÏÑúÎ≤ÑÏóêÏÑú "Game Started" Ïã†Ìò∏Í∞Ä ÏôîÎäîÏßÄ Ï≤¥ÌÅ¨
        int n = recv(sock, buf, BUF_SIZE-1, MSG_DONTWAIT);
        if (n > 0) {
            buf[n] = '\0';
            strncat(recv_buf, buf, sizeof(recv_buf) - strlen(recv_buf) - 1);
            if (strstr(recv_buf, "Game Started")) break;
        }
    }

    // Î≥∏Í≤åÏûÑ Î£®ÌîÑ
    while(1){
        long long now = get_current_time_ms();
        if(in_delay && now >= delay_until) in_delay=0;
        // ÌñâÎèô ÌååÏã± json
        int ch = getch(), sent = 0;
        if      (ch==24){ ts=now; in_delay=1; delay_until=ts+DELAY_ATTACK;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"ATTACK\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                Player.nick, ts); sent=1;
        } else if (ch==26){ ts=now; in_delay=1; delay_until=ts+DELAY_BLOCK;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"BLOCK\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                Player.nick, ts); sent=1;
        } else if (ch==3){ ts=now; in_delay=1;
            // ÏïÑÏù¥ÌÖú Ìö®Í≥º Ï†ÅÏö© (ÏµúÏÜå 100ms Î≥¥Ïû•)
            long delay = DELAY_CHARGE_WEAK - Player.pvp_charge_minus;
            if(delay < 100) delay = 100;
            delay_until=ts+delay;
            snprintf(buf,BUF_SIZE,
        "{\"action\":\"CHARGE_WEAK\",\"nickname\":\"%s\",\"timestamp\":%lld}",
        Player.nick, ts); sent=1;
        } else if (ch==1){ ts=now; in_delay=1;
            long delay = DELAY_CHARGE_STRONG - Player.pvp_charge_minus;
            if(delay < 100) delay = 100;
            delay_until=ts+delay;
            snprintf(buf,BUF_SIZE,
        "{\"action\":\"CHARGE_STRONG\",\"nickname\":\"%s\",\"timestamp\":%lld}",
        Player.nick, ts); sent=1;
        } else if (ch==19){ ts=now; in_delay=1; delay_until=ts+COUNTER_WINDOW;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"COUNTER\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                Player.nick, ts); sent=1;
        } else if (ch=='q') break;
        if(sent) send(sock, buf, strlen(buf), 0);

        // ÏÑúÎ≤Ñ ÏùëÎãµ ÌååÏã±
        int n = recv(sock, buf, BUF_SIZE-1, MSG_DONTWAIT);
        if (n > 0) {
            buf[n] = '\0';
            char *s0 = strstr(buf, "\"self\":");
            char *s1 = strstr(buf, "\"opponent\":");
            if (s0) sscanf(s0, "\"self\":{\"data\":%d,\"max_data\":%d,\"charged_attack\":%d,\"nickname\":\"%*31[^\"]\"}", &my_data, &my_max_data, &my_charge);
            if (s1) sscanf(s1, "\"opponent\":{\"data\":%d,\"max_data\":%d,\"charged_attack\":%d,\"nickname\":\"%31[^\"]\"}", &en_data, &en_max_data, &en_charge, opponent_name);

            char *p = buf;
            while (1) {
                char *ev = strstr(p, "\"event\":\"");
                if (!ev) break;
                ev += strlen("\"event\":\"");
                char *e1 = strchr(ev, '"');
                if (!e1) break;
                *e1 = '\0';
                add_log(ev);

                if (strstr(ev, "Game Over")) {
                    result = strstr(ev, "You Win")   ? 1
                           : strstr(ev, "You Lose") ? -1
                                                     : 0;
                    endwin();

                    if (result == 1) {
                        winner_ending_screen();  // Diver_ui.c
                        // winner_ending_screenÏù¥ _exit(0); ÌïòÎØÄÎ°ú Ïù¥ÌõÑ ÏΩîÎìú Ïã§ÌñâÎêòÏßÄ ÏïäÏùå
                    } else if (result == -1) {
                        loser_ending_screen();   // Diver_ui.c
                        // loser_ending_screenÏù¥ _exit(0); ÌïòÎØÄÎ°ú Ïù¥ÌõÑ ÏΩîÎìú Ïã§ÌñâÎêòÏßÄ ÏïäÏùå
                    } else {
                        // Î¨¥ÏäπÎ∂Ä Îì± Í∏∞ÌÉÄ: Î©îÏãúÏßÄ Ï∂úÎ†•
                        printf("Draw. No ending screen.\n");
                        _exit(0);
                    }
                    goto done;
                }
                p = e1 + 1;
            }
        }

        erase();
        if(in_delay) attron(COLOR_PAIR(1)); else attron(COLOR_PAIR(2));
        box(stdscr,0,0);
        if(in_delay) attroff(COLOR_PAIR(1)); else attroff(COLOR_PAIR(2));
        draw_status(Player.nick,
            my_data, my_max_data, my_charge,
            opponent_name,
            en_data, en_max_data, en_charge);
        draw_ctrl();
        draw_logs();
        refresh();
        usleep(10000);
    }
done:
    endwin();
    reset_shell_mode();
    system("clear");
    return result;
}
