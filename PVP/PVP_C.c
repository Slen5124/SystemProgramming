// PVP_C.c ‚Äì JSON Í∏∞Î∞ò ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ (130√ó35 Î†àÏù¥ÏïÑÏõÉ Í∏∞Ï§Ä)
// üé∂ ÏõÖÏû•Ìïú ÏäπÌå® ÌôîÎ©¥, ÏûêÎèô ÌÑ∞ÎØ∏ÎÑê Î≥µÍµ¨ÍπåÏßÄ! raw Î™®Îìú+XON/XOFFÎ°ú Ctrl ÌÇ§ Ï∫°Ï≤ò

#define _XOPEN_SOURCE_EXTENDED

#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <locale.h>
#include <signal.h>
#include <termios.h>            // IXON/IXOFF Ï†úÏñ¥
#include <ncursesw/ncurses.h>   // wide-char ncurses (def_shell_mode Îì±)
#include <sys/socket.h>
#include <arpa/inet.h>
#include <stdbool.h>

#include "shared_eco.h"         // get_current_time_ms(), DELAY_*, PlayerState Îì±
#include "json_topic.h"         // JSON ÌååÏã±/ÏÉùÏÑ± Ìï®Ïàò

#define DEFAULT_SERVER_IP   "172.20.12.161"
#define PORT                5124
#define BUF_SIZE            1024
#define LOG_LINES           5
#define MAX_DATA            100
#define FILLED_CHR          "‚ñà"
#define EMPTY_CHR           " "
#define BAR_LEN             20



void draw_dot_art() {
    const char *art[] = {
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚£§‚£†‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£û‚°∑‚£ª‚¢û‚°≥‚£è‚¢æ‚°π‚£ñ‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢æ‚£±‚¢è‚°∑‚¢´‚†µ‚£©‚†é‚°µ‚†à‚†ú‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚£ú‚¢Ø‚°ú‚££‚¢£‚°ë‚¢é‚†ê‚£Å‚†¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Æ‚¢≥‚°π‚¢∞‚°ê‚†Ñ‚†¢‚¢Ñ‚¢®‚†Å‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£á‚¢É‚†í‚°†‚†ô‚£Ç‚†°‚¢å‚¢Ç‚°ë‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°∏‚¢Ä‚†£‚¢à‚†∞‚°Ä‚¢º‚†≥‚£å‚†¢‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚¢¢‚†ë‚†Ç‚°å‚†Ñ‚†Ç‚†ë‚†é‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚°†‚†å‚°Ä‚†ê‚°Ä‚¢å‚°ë‚††‚¢à‚†ê‚††‚†à‚°ê‚††‚††‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢†‚¢£‚°ë‚¢Ü‚†ê‚°Ä‚†ê‚°Ü‚¢Ñ‚†£‚†ê‚†®‚†ê‚††‚†Ä‚†ê‚†Ä‚†Ç‚†à‚¢Ñ‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚†í‚°ú‚£å‚††‚£Ä‚†π‚°ê‚¢å‚†Ü‚†°‚¢à‚†Å‚¢Ü‚†Å‚†å‚†ê‚†Ä‚†°‚¢à‚†Ñ‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚¢ã‚†¥‚°®‚†î‚£Ä‚†≥‚°à‚¢û‚†§‚¢Å‚†Ç‚†å‚°Ä‚¢ä‚†î‚°°‚¢à‚†ê‚¢†‚†ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢ß‚£ã‚¢ñ‚°°‚¢´‚†Ñ‚££‚†ë‚¢é‚°ñ‚°à‚¢å‚††‚°ë‚°å‚£û‚†°‚¢Ç‚†ú‚°†‚†É‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚£Æ‚°ë‚°£‚¢é‚°±‚£â‚†Ü‚°ô‚¢¶‚£à‚†±‚°ê‚°°‚¢è‚°î‚†Ä‚¢Ç‚†°‚°Å‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚¢¶‚°ô‚¢∂‚¢°‚¢ö‚°•‚¢ä‚°±‚†å‚¢¶‚†±‚£†‚†£‚£è‚†î‚°â‚¢Ä‚†¢‚£Å‚†Ä‚†Ä‚†Ä",
        "‚†à‚¢¶‚°ô‚¢Æ‚°ù‚¢Æ‚°ë‚°é‚°µ‚£É‚†ñ‚°©‚¢Ü‚°±‚¢†‚¢õ‚°º‚£ä‚†î‚°Å‚¢¢‚†ê‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†ß‚£ú‚¢£‚†û‚£•‚¢õ‚°¨‚°±‚£è‚¢é‚°±‚¢å‚†≤‚£°‚¢è‚°æ‚£±‚¢ä‚†î‚°†‚¢ç‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†≥‚£å‚¢ß‚¢´‚†Ä‚£è‚†∂‚°ë‚£é‚¢Æ‚¢±‚£ä‚†ï‚°¢‚¢è‚°æ‚°±‚¢´‚†Ñ‚°±‚¢å‚¢Ç‚†Ä‚†Ä",
        "‚†Ä‚†ò‚°¨‚¢é‚°≠‚¢≥‚°å‚¢≥‚°ë‚£é‚¢Ü‚†£‚¢å‚¢ä‚†±‚£©‚¢û‚°•‚£õ‚†º‚£†‚¢â‚†≤‚°Ä‚†Ä"
    };
    for (int i = 0; i < sizeof(art)/sizeof(art[0]); i++) {
        mvprintw(7 + i, 15, "%s", art[i]);
    }
}

void draw_dot_art_enemy() {
    const char *art[] = {
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£Ä‚£Ä‚£§‚£†‚£Ñ‚£Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚£û‚°∑‚£ª‚¢û‚°≥‚£è‚¢æ‚°π‚£ñ‚°Ñ‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢æ‚£±‚¢è‚°∑‚¢´‚†µ‚£©‚†é‚°µ‚†à‚†ú‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢ª‚£ú‚¢Ø‚°ú‚££‚¢£‚°ë‚¢é‚†ê‚£Å‚†¶‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†ò‚£Æ‚¢≥‚°π‚¢∞‚°ê‚†Ñ‚†¢‚¢Ñ‚¢®‚†Å‚°Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚£á‚¢É‚†í‚°†‚†ô‚£Ç‚†°‚¢å‚¢Ç‚°ë‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢Ä‚°∏‚¢Ä‚†£‚¢à‚†∞‚°Ä‚¢º‚†≥‚£å‚†¢‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚¢†‚¢¢‚†ë‚†Ç‚°å‚†Ñ‚†Ç‚†ë‚†é‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä  ‚†Ä",
        "‚†Ä‚†Ä‚†Ä‚†Ä‚°†‚†å‚°Ä‚†ê‚°Ä‚¢å‚°ë‚††‚¢à‚†ê‚††‚†à‚°ê‚††‚††‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢†‚¢£‚°ë‚¢Ü‚†ê‚°Ä‚†ê‚°Ü‚¢Ñ‚†£‚†ê‚†®‚†ê‚††‚†Ä‚†ê‚†Ä‚†Ç‚†à‚¢Ñ‚†Ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚†í‚°ú‚£å‚††‚£Ä‚†π‚°ê‚¢å‚†Ü‚†°‚¢à‚†Å‚¢Ü‚†Å‚†å‚†ê‚†Ä‚†°‚¢à‚†Ñ‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚£ß‚¢ã‚†¥‚°®‚†î‚£Ä‚†≥‚°à‚¢û‚†§‚¢Å‚†Ç‚†å‚°Ä‚¢ä‚†î‚°°‚¢à‚†ê‚¢†‚†ä‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚¢ß‚£ã‚¢ñ‚°°‚¢´‚†Ñ‚££‚†ë‚¢é‚°ñ‚°à‚¢å‚††‚°ë‚°å‚£û‚†°‚¢Ç‚†ú‚°†‚†É‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚£Æ‚°ë‚°£‚¢é‚°±‚£â‚†Ü‚°ô‚¢¶‚£à‚†±‚°ê‚°°‚¢è‚°î‚†Ä‚¢Ç‚†°‚°Å‚†Ä‚†Ä‚†Ä",
        "‚†ò‚¢¶‚°ô‚¢¶‚°ô‚¢∂‚¢°‚¢ö‚°•‚¢ä‚°±‚†å‚¢¶‚†±‚£†‚†£‚£è‚†î‚°â‚¢Ä‚†¢‚£Å‚†Ä‚†Ä‚†Ä",
        "‚†à‚¢¶‚°ô‚¢Æ‚°ù‚¢Æ‚°ë‚°é‚°µ‚£É‚†ñ‚°©‚¢Ü‚°±‚¢†‚¢õ‚°º‚£ä‚†î‚°Å‚¢¢‚†ê‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†ß‚£ú‚¢£‚†û‚£•‚¢õ‚°¨‚°±‚£è‚¢é‚°±‚¢å‚†≤‚£°‚¢è‚°æ‚£±‚¢ä‚†î‚°†‚¢ç‚†Ä‚†Ä‚†Ä",
        "‚†Ä‚†≥‚£å‚¢ß‚¢´‚†Ä‚£è‚†∂‚°ë‚£é‚¢Æ‚¢±‚£ä‚†ï‚°¢‚¢è‚°æ‚°±‚¢´‚†Ñ‚°±‚¢å‚¢Ç‚†Ä‚†Ä",
        "‚†Ä‚†ò‚°¨‚¢é‚°≠‚¢≥‚°å‚¢≥‚°ë‚£é‚¢Ü‚†£‚¢å‚¢ä‚†±‚£©‚¢û‚°•‚£õ‚†º‚£†‚¢â‚†≤‚°Ä‚†Ä"
    };
    int lines = sizeof(art)/sizeof(art[0]);
    setlocale(LC_ALL, "");
    for (int i = 0; i < lines; i++) {
        // UTF-8 -> wchar_t Î≥ÄÌôò
        wchar_t wbuf[128];
        mbstowcs(wbuf, art[i], 128);
        int len = wcslen(wbuf);
        // Ï¢åÏö∞ Î∞òÏ†Ñ
        for (int j = 0; j < len/2; j++) {
            wchar_t tmp = wbuf[j];
            wbuf[j] = wbuf[len-1-j];
            wbuf[len-1-j] = tmp;
        }
        // Îã§Ïãú Î©ÄÌã∞Î∞îÏù¥Ìä∏Î°ú
        char mbbuf[256];
        wcstombs(mbbuf, wbuf, 256);
        // 92Ïó¥ÏóêÏÑú Ï∂úÎ†•
        mvprintw(7 + i, 91, "%s", mbbuf);
    }
}


// ‚îÄ Ï†ÑÏó≠ ÏÉÅÌÉú Î≥ÄÏàò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
static char     logs[LOG_LINES][BUF_SIZE];
static int      logi           = 0;
static char     opponent_name[32] = "???";
static int      my_data   = MAX_DATA,   my_charge = 0;
static int      en_data   = MAX_DATA,   en_charge = 0;
static long long delay_until = 0;
static int       in_delay     = 0;

// ‚îÄ ÏõÖÏû•Ìïú ÏäπÌå® ÌôîÎ©¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void draw_grand_result(int win) {
    int y, x;
    getmaxyx(stdscr, y, x);
    clear();
    if      (win > 0)  attron(COLOR_PAIR(5)); // ÏäπÎ¶¨
    else if (win == 0) attron(COLOR_PAIR(6)); // Î¨¥ÏäπÎ∂Ä
    else               attron(COLOR_PAIR(7)); // Ìå®Î∞∞
    for (int i = 0; i < y; i++) mvhline(i, 0, ' ', x);

    const char *banner[] = {
        "..######..##....##.########.##.......########..######.",
        ".##....##.##...##..##.......##.......##.......##....##",
        ".##.......##..##...##.......##.......##.......##......",
        ".##.......#####....######...##.......######...##......",
        ".##.......##..##...##.......##.......##.......##......",
        ".##....##.##...##..##.......##.......##.......##....##",
        "..######..##....##.########.########.########..######."
    };
    int lines  = sizeof(banner)/sizeof(banner[0]);
    int starty = (y - lines)/2 - 2;
    attron(A_BOLD);
    for(int i=0;i<lines;i++){
        mvprintw(starty+i, (x-strlen(banner[i]))/2, "%s", banner[i]);
    }
    attroff(A_BOLD);

    const char *msg = win>0
        ? "üéâ VICTORY! Press 'q' to quit üéâ"
        : win==0
        ? "ü§ù IT'S A DRAW! Press 'q' to quit ü§ù"
        : "üíÄ DEFEATED! Press 'q' to quit üíÄ";
    attron(A_UNDERLINE|A_BOLD);
    mvprintw(starty+lines+2, (x-strlen(msg))/2, "%s", msg);
    attroff(A_UNDERLINE|A_BOLD);

    refresh();
    nodelay(stdscr, FALSE);
    while(getch()!='q');
    endwin();
    reset_shell_mode();
    system("clear");
    exit(0);
}

// ‚îÄ Î°úÍ∑∏ Ìï®Ïàò ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void add_log(const char *msg) {
    strncpy(logs[logi%LOG_LINES], msg, BUF_SIZE-1);
    logs[logi%LOG_LINES][BUF_SIZE-1] = '\0';
    logi++;
}
void draw_logs() {
    int start = logi>LOG_LINES ? logi-LOG_LINES : 0;
    for(int i=0;i<LOG_LINES;i++){
        mvprintw(28+i, 4, "%s", logs[(start+i)%LOG_LINES]);
    }
}

// ‚îÄ ÏÉÅÌÉú Î∞î Í∑∏Î¶¨Í∏∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void draw_bar(int y,int x,int val,const char *lab){
    int v = val<0?0:(val>MAX_DATA?MAX_DATA:val);
    int f = v*BAR_LEN/MAX_DATA;
    mvprintw(y, x, "%-8s ", lab);
    for(int i=0;i<BAR_LEN;i++) printw(i<f?FILLED_CHR:EMPTY_CHR);
    printw(" %3d/%3d", v, MAX_DATA);
}
void draw_status(const char *nick) {
    mvprintw(1,2,  "üßë You:   %-12s", nick);
    draw_bar(3,2,my_data,"DATA");
    draw_bar(5,2,my_charge,"‚ö°CHARGE");
    mvprintw(1,90,"üëæEnemy:  %-12s", opponent_name);
    draw_bar(3,90,en_data,"DATA");
    draw_bar(5,90,en_charge,"‚ö°CHARGE");
    draw_dot_art();
    draw_dot_art_enemy();
}

// ‚îÄ Ïª®Ìä∏Î°§ ÏïàÎÇ¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
void draw_ctrl() {
    mvprintw(28, 90, "[Ctrl+X] ATTACK   [Ctrl+Z] BLOCK");
    mvprintw(30, 90, "[Ctrl+C] Charge√ó3 [Ctrl+A] Charge√ó5");
    mvprintw(32, 90, "[Ctrl+S] COUNTER   [q] Quit");
}

// ‚îÄ Î©îÏù∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
int main(int argc, char *argv[]) {
    def_shell_mode();

    setlocale(LC_ALL,"");
    signal(SIGINT, SIG_IGN);
    signal(SIGTSTP,SIG_IGN);

    // XON/XOFF Ìï¥Ï†ú
    struct termios tt; tcgetattr(0,&tt);
    tt.c_iflag&=~(IXON|IXOFF); tcsetattr(0,TCSANOW,&tt);

    // ÏÑúÎ≤Ñ IP Ïù∏Ïûê Ï≤òÎ¶¨
    const char *server_ip = (argc>=2 ? argv[1] : DEFAULT_SERVER_IP);

    // ÎãâÎÑ§ÏûÑ
    char nick[32]; printf("Enter your nickname: "); scanf("%31s",nick);

    // ÏÑúÎ≤Ñ Ïó∞Í≤∞
    int sock = socket(AF_INET,SOCK_STREAM,0);
    struct sockaddr_in srv={.sin_family=AF_INET,.sin_port=htons(PORT)};
    if(inet_pton(AF_INET,server_ip,&srv.sin_addr)!=1){
        perror("inet_pton"); exit(1);
    }
    if(connect(sock,(struct sockaddr*)&srv,sizeof(srv))<0){
        perror("connect"); exit(1);
    }

    // REGISTER
    char buf[BUF_SIZE]; long long ts=get_current_time_ms();
    snprintf(buf,BUF_SIZE,
        "{\"action\":\"REGISTER\",\"nickname\":\"%s\",\"timestamp\":%lld}",
        nick,ts);
    send(sock,buf,strlen(buf),0);

    // ‚ÄúGame Started‚Äù ÏàòÏã† & ÏÉÅÎåÄ ÎãâÎÑ§ÏûÑ ÌååÏã±
    while(recv(sock,buf,BUF_SIZE-1,0)<=0);
    add_log("Game Started");
    parse_nickname_from_json(buf, opponent_name, sizeof(opponent_name));

    // ncurses Ï¥àÍ∏∞Ìôî
    initscr(); def_prog_mode();
    raw(); noecho(); keypad(stdscr,TRUE);
    nodelay(stdscr,TRUE); timeout(0); curs_set(0);

    // ÏÉâÏÉÅ ÌéòÏñ¥
    start_color();
    init_pair(1, COLOR_RED,    COLOR_BLACK);
    init_pair(2, COLOR_GREEN,  COLOR_BLACK);
    init_pair(5, COLOR_YELLOW, COLOR_BLUE);
    init_pair(6, COLOR_WHITE,  COLOR_MAGENTA);
    init_pair(7, COLOR_WHITE,  COLOR_RED);

    // Î©îÏù∏ Î£®ÌîÑ (100Hz)
    while(1){
        long long now = get_current_time_ms();
        if(in_delay && now>=delay_until) in_delay=0;

        int ch=getch(), sent=0;
        if      (ch==24){ ts=now; in_delay=1; delay_until=ts+DELAY_ATTACK;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"ATTACK\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                nick,ts); sent=1;
        } else if (ch==26){ ts=now; in_delay=1; delay_until=ts+DELAY_BLOCK;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"BLOCK\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                nick,ts); sent=1;
        } else if (ch==3){ ts=now; in_delay=1; delay_until=ts+DELAY_CHARGE_WEAK;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"CHARGE_WEAK\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                nick,ts); sent=1;
        } else if (ch==1){ ts=now; in_delay=1; delay_until=ts+DELAY_CHARGE_STRONG;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"CHARGE_STRONG\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                nick,ts); sent=1;
        } else if (ch==19){ ts=now; in_delay=1; delay_until=ts+COUNTER_WINDOW;
            snprintf(buf,BUF_SIZE,
                "{\"action\":\"COUNTER\",\"nickname\":\"%s\",\"timestamp\":%lld}",
                nick,ts); sent=1;
        } else if (ch=='q') break;
        if(sent) send(sock,buf,strlen(buf),0);

        // ÏÑúÎ≤Ñ ÏùëÎãµ
        // (ÏõêÎûò ÏûàÎçò ÏúÑÏπòÏóê ÎçÆÏñ¥Ïì∞Í∏∞)
        int n = recv(sock, buf, BUF_SIZE-1, MSG_DONTWAIT);
        if (n > 0) {
            buf[n] = '\0';

            // 1) ÏÉÅÎåÄ ÎãâÎÑ§ÏûÑ Í∞±Ïã† (ÌïÑÏöîÌïòÎ©¥ Ïó¨Í∏∞ÏÑú)
            parse_nickname_from_json(buf, opponent_name, sizeof(opponent_name));

            // 2) event Î©îÏãúÏßÄÎßå Ïó∞ÏÜçÏúºÎ°ú Ï∞æÏïÑÏÑú Ï≤òÎ¶¨
            char *p = buf;
            while (1) {
                char *ev = strstr(p, "\"event\":\"");
                if (!ev) break;
                ev += strlen("\"event\":\"");
                char *e1 = strchr(ev, '"');
                if (!e1) break;
                *e1 = '\0';

                // Î°úÍ∑∏ÏóêÎèÑ ÎÇ®Í∏∞Í≥†
                add_log(ev);

                // Game Over Í∞êÏßÄ
                if (strstr(ev, "Game Over")) {
                    int result = strstr(ev, "You Win")   ? 1
                                : strstr(ev, "You Lose") ? -1
                                                        : 0;
                    draw_grand_result(result);
                }

                // Îã§Ïùå Í≤ÄÏÉâ ÏúÑÏπòÎäî Î∞©Í∏à Îã´ÏùÄ Îî∞Ïò¥Ìëú Îí§
                p = e1 + 1;
            }

            // 3) self/opponent ÏÉÅÌÉúÎäî ÎßàÏßÄÎßâ JSON Î∏îÎ°ùÏóêÏÑú ÎΩëÏïÑÏ£ºÏÑ∏Ïöî
            //    (ÌïÑÏöîÌïòÎã§Î©¥ ÏúÑ Î£®ÌîÑ ÏïàÏ™ΩÏóêÏÑúÎèÑ Îß§Î≤à Í∞±Ïã†Ìï¥ÎèÑ Î¨¥Î∞©Ìï©ÎãàÎã§)
            char *s0 = strstr(buf, "\"self\":");
            if (s0) sscanf(s0, "\"self\":{\"data\":%d,\"charged_attack\":%d}", &my_data, &my_charge);
            char *s1 = strstr(buf, "\"opponent\":");
            if (s1) sscanf(s1, "\"opponent\":{\"data\":%d,\"charged_attack\":%d}", &en_data, &en_charge);
        }


        // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        erase();
        if(in_delay) attron(COLOR_PAIR(1)); else attron(COLOR_PAIR(2));
        box(stdscr,0,0);
        if(in_delay) attroff(COLOR_PAIR(1)); else attroff(COLOR_PAIR(2));

        draw_status(nick);
        draw_ctrl();
        draw_logs();
        refresh();
        usleep(10000);
    }

    // Ï¢ÖÎ£å Î≥µÍ∑Ä
    endwin();
    reset_shell_mode();
    system("clear");
    close(sock);
    return 0;
}
